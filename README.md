# IJVM-Emulator

## Bonus assignments
### Heap + Garbage Collector

The heap and garbage collector are actually quite simple and probably far too inefficient, but whatever.

I made two structs:  
`array_t`: Stores array's size, reference and data.  
`arrays_t`: Keeps track of all the arrays allocated.

I thought about where the `ref` could be stored and I found that it could only be stored in a programs `local_data` and `stack_data`. The constant pool is read-only.

References are generated by random (srand(time()), rand()). This means that there is a very small chance that a random value on the stack or local's could unintentionally also be a reference to an array causing it to be not deleted. I guess its better to not delete than the other way around...

At every IRETURN (and `OP_GC`) the garbage collector is called. The garbage collector is similar to mark and sweep in that in will first do a round of searching for lost references and another round for 'copying' or 'removing' lost references.

Round 1: recursive search in each possible value in stack and locals and check if their value corresponds to a reference. Mark an array's `wipe` member as true if it can't be found.

Round 2: copy every array which has not been marked with `wipe` to a new `arrays_t` and free the others.

Finally, replace the previous `arrays_t` with the (smaller) new `arrays_t`.
